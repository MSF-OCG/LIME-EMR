name: OpenFn connection test 

on:
  push:
    branches: ["test-uat-dhis2-network"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.LIME_MOSUL_AZURE_UAT_SSH_KEY }}
          log-public-key: false
      
      - name: Add SSH known hosts
        run: |
          ssh-keyscan -p 22222 -H lime-mosul-uat.madiro.org >> ~/.ssh/known_hosts
      
      - name: Testing UAT Environment - HTTPS Connectivity
        run: |
          ssh -p 22222 ${{ secrets.LIME_MOSUL_AZURE_UAT_SSH_USER }}@lime-mosul-uat.madiro.org << 'EOF'
            set -e
            
            echo "================================================"
            echo "Testing HTTPS connectivity to dhis2-uat.ocg.msf.org"
            echo "================================================"
            echo ""
            
            echo "1. DNS Resolution Test:"
            echo "------------------------"
            nslookup dhis2-uat.ocg.msf.org || dig dhis2-uat.ocg.msf.org
            echo ""
            
            echo "3. Telnet Connection Test (Port 443):"
            echo "--------------------------------------"
            timeout 10 telnet dhis2-uat.ocg.msf.org 443 || echo "Telnet connection failed or timed out"
            echo ""
            
            echo "4. OpenSSL HTTPS Connection Test:"
            echo "-----------------------------------"
            timeout 10 openssl s_client -connect dhis2-uat.ocg.msf.org:443 -servername dhis2-uat.ocg.msf.org </dev/null 2>&1 | head -n 30
            echo ""
            
            echo "5. Curl HTTPS Test:"
            echo "--------------------"
            curl -v -I --connect-timeout 10 https://dhis2-uat.ocg.msf.org 2>&1 | head -n 40
            echo ""
            
            echo "================================================"
            echo "Test completed"
            echo "================================================"
          EOF
