name: OpenFn connection test 

on:
  push:
    branches: ["test-uat-dhis2-network"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.LIME_MOSUL_AZURE_UAT_SSH_KEY }}
          log-public-key: false
      
      - name: Add SSH known hosts
        run: |
          ssh-keyscan -p 22222 -H lime-mosul-uat.madiro.org >> ~/.ssh/known_hosts
      
      - name: Testing UAT Environment - HTTPS Connectivity
        run: |
          ssh ${{ secrets.LIME_MOSUL_AZURE_UAT_SSH_USER }}@lime-mosul-uat.madiro.org -p 22222 << 'EOF'
            set -e
            
            echo "================================================"
            echo "Enhanced Network Diagnostics"
            echo "================================================"
            echo ""
            
            echo "1. DNS Resolution:"
            echo "------------------"
            nslookup dhis2-uat.ocg.msf.org
            echo ""
            
            echo "2. Ping Test (ICMP):"
            echo "--------------------"
            ping -c 4 dhis2-uat.ocg.msf.org || echo "Ping blocked or host unreachable"
            echo ""
            
            echo "3. Traceroute to Host:"
            echo "----------------------"
            traceroute -m 20 dhis2-uat.ocg.msf.org || echo "Traceroute failed"
            echo ""
            
            echo "4. TCP Traceroute to Port 443:"
            echo "-------------------------------"
            traceroute -p 443 -m 20 dhis2-uat.ocg.msf.org || echo "TCP traceroute failed"
            echo ""
            
            echo "5. Route to Destination:"
            echo "------------------------"
            ip route get 195.20.146.25
            echo ""
            
            echo "6. Netcat Connection Test:"
            echo "--------------------------"
            timeout 10 nc -vz dhis2-uat.ocg.msf.org 443 2>&1 || echo "Netcat test failed"
            echo ""
            
            echo "7. Curl with Verbose Output:"
            echo "----------------------------"
            curl -v -I --connect-timeout 10 https://dhis2-uat.ocg.msf.org 2>&1
            echo ""

            echo "8. OpenSSL HTTPS Connection Test:"
            echo "-----------------------------------"
            timeout 10 openssl s_client -connect dhis2-uat.ocg.msf.org:443 -servername dhis2-uat.ocg.msf.org 
            echo ""
            
            echo "================================================"
            echo "Diagnostics completed"
            echo "================================================"
          EOF
