name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: [ "main" ]
  release:
    types: [published]

jobs:
  snapshot:
    if: ${{ (github.event_name == 'push' && github.ref == 'refs/heads/main') }}
    uses: ./.github/workflows/maven-publish.yml
    with:
      free-disk-space: true
      maven-args: "-Pazure -Pbundled-docker"
    secrets:
      NEXUS_USERNAME: ${{ secrets.MAVEN_GITHUB_ACTIONS_DEPLOY_USERNAME }}
      NEXUS_PASSWORD: ${{ secrets.MAVEN_GITHUB_ACTIONS_DEPLOY_TOKEN }}
      DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_REGISTRY_USERNAME }}
      DOCKER_HUB_PASSWORD: ${{ secrets.DOCKER_HUB_REGISTRY_PASSWORD }}

  release:
    if: ${{ github.event_name == 'release' }}
    uses: ./.github/workflows/maven-publish.yml
    with:
      free-disk-space: true
      maven-args: "-Pazure -Pbundled-docker -Pproduction"
    secrets:
      NEXUS_USERNAME: ${{ secrets.MAVEN_GITHUB_ACTIONS_DEPLOY_USERNAME }}
      NEXUS_PASSWORD: ${{ secrets.MAVEN_GITHUB_ACTIONS_DEPLOY_TOKEN }}
      DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_REGISTRY_USERNAME }}
      DOCKER_HUB_PASSWORD: ${{ secrets.DOCKER_HUB_REGISTRY_PASSWORD }}
  
  deploy-to-dev:
    # needs: [snapshot, release]
    # if: ${{ (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'release' }}
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.LIME_MOSUL_AZURE_DEV_SSH_KEY }}
      
      - name: Add SSH known hosts
        run: |
          ssh-keyscan -H 57.152.32.79 >> ~/.ssh/known_hosts
      
      - name: Deploy to Dev Environment
        run: |
          ssh azureuser@57.152.32.79 << 'EOF'
            set -e
            
            # Navigate to MOSUL directory
            cd /home/azureuser/MOSUL
            
            # Pull bundled docker scripts
            curl -sSL -H 'Cache-Control: no-cache, no-store' \
              -H 'Authorization: token ${{ secrets.LIME_EMR_TOOLING_GITHUB_TOKEN }}' \
              https://raw.githubusercontent.com/MSF-OCG/LIME-EMR-Tooling/main/Procedures/pull_bundled_docker_scripts.sh | bash

            # Add BACKUP_PATH in azure.concatenated.env
            sed -i 's|^BACKUP_PATH=.*|BACKUP_PATH=/home/azureuser/BACKUPS/restic|' /home/azureuser/MOSUL/Bundled-Docker/azure.concatenated.env
            
            # Navigate to scripts directory
            cd /home/azureuser/MOSUL/Bundled-Docker/scripts
            
            # Start LIME services
            export TRAEFIK="true" && export INSTANCE="dev" && bash start-bundled.sh
          EOF
      
      - name: Verify Deployment
        run: |
          echo "Deployment to dev environment completed successfully"
            
