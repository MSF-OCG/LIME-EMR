name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: [ "main" ]
  release:
    types: [published]

jobs:
  snapshot:
    if: ${{ (github.event_name == 'push' && github.ref == 'refs/heads/main') }}
    uses: ./.github/workflows/maven-publish.yml
    with:
      free-disk-space: true
      maven-args: "-Pazure -Pbundled-docker"
    secrets:
      NEXUS_USERNAME: ${{ secrets.MAVEN_GITHUB_ACTIONS_DEPLOY_USERNAME }}
      NEXUS_PASSWORD: ${{ secrets.MAVEN_GITHUB_ACTIONS_DEPLOY_TOKEN }}
      DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_REGISTRY_USERNAME }}
      DOCKER_HUB_PASSWORD: ${{ secrets.DOCKER_HUB_REGISTRY_PASSWORD }}

  release:
    if: ${{ github.event_name == 'release' }}
    uses: ./.github/workflows/maven-publish.yml
    with:
      free-disk-space: true
      maven-args: "-Pazure -Pbundled-docker -Pproduction"
    secrets:
      NEXUS_USERNAME: ${{ secrets.MAVEN_GITHUB_ACTIONS_DEPLOY_USERNAME }}
      NEXUS_PASSWORD: ${{ secrets.MAVEN_GITHUB_ACTIONS_DEPLOY_TOKEN }}
      DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_REGISTRY_USERNAME }}
      DOCKER_HUB_PASSWORD: ${{ secrets.DOCKER_HUB_REGISTRY_PASSWORD }}
  
  deploy-to-dev:
    # needs: [snapshot, release]
    # if: ${{ (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'release' }}
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.LIME_MOSUL_AZURE_DEV_SSH_KEY }}
      
      - name: Add SSH known hosts
        run: |
          ssh-keyscan -H 57.152.32.79 >> ~/.ssh/known_hosts
      
      - name: Deploy to Dev Environment
        run: |
          ssh azureuser@57.152.32.79 << 'EOF'
            set -e
            
            # Navigate to MOSUL directory
            cd /home/azureuser/MOSUL
            
            # Pull bundled docker scripts
            curl -sSL -H 'Cache-Control: no-cache, no-store' \
              -H 'Authorization: token ${{ secrets.LIME_EMR_TOOLING_GITHUB_TOKEN }}' \
              https://raw.githubusercontent.com/MSF-OCG/LIME-EMR-Tooling/main/Procedures/pull_bundled_docker_scripts.sh | bash

            # Add BACKUP_PATH in azure.concatenated.env
            sed -i 's|^BACKUP_PATH=.*|BACKUP_PATH=/home/azureuser/BACKUPS/restic|' /home/azureuser/MOSUL/Bundled-Docker/azure.concatenated.env
            
            # Navigate to scripts directory
            cd /home/azureuser/MOSUL/Bundled-Docker/scripts
            
            # Start LIME services
            export TRAEFIK="true" && export INSTANCE="dev" && bash start-bundled.sh
          EOF

  e2e-tests:
    needs: deploy-to-dev
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout repo
        uses: actions/checkout@v4

      - name: ðŸ“ Copy test environment variables
        run: cp e2e/e2e.env.example e2e/e2e.env

      - name: ðŸ› ï¸ Setup node
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'yarn'

      - name: ðŸ“¦ Install dependencies
        run: yarn install --immutable

      - name: ðŸŽ­ Install Playwright Browsers
        run: npx playwright install --with-deps chromium

      - name: â³ Wait for OpenFN instance to start
        run: while [[ "$(curl -s -o /dev/null -w ''%{http_code}'' https://lime-mosul-dev.madiro.org:4000/users/log_in)" != "200" ]]; do sleep 10; done

      - name: â³ Wait for OpenMRS instance to start
        run: while [[ "$(curl -s -o /dev/null -w ''%{http_code}'' https://lime-mosul-dev.madiro.org/openmrs/login.htm)" != "200" ]]; do sleep 10; done

      - name: ðŸ§ª Run E2E tests
        run: yarn test:login

      - name: ðŸ“¤ Upload report
        uses: actions/upload-artifact@v4
        if: '!cancelled()'
        with:
          name: playwright-report
          path: e2e/playwright-report/
          retention-days: 7
          overwrite: true
            
