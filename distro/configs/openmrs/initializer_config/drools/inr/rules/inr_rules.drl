package org.openmrs.module.drools.inr

import org.openmrs.Patient
import org.openmrs.Obs
import org.openmrs.Concept
import org.openmrs.api.context.Context
import org.openmrs.module.patientflags.PatientFlag

global Object service;

rule "High_INR"
    agenda-group "highinr"
    when
        $patient: Patient()
    then
        Concept inrConcept = Context.getConceptService().getConceptByMapping("161482", "CIEL");

        java.util.List<Obs> obsList = Context.getObsService().getObservationsByPersonAndConcept(
            $patient,
            inrConcept
        );

        Double inr = null;

        if (obsList != null && !obsList.isEmpty()) {
            for (Obs obs : obsList) {
                if (obs != null && !obs.getVoided() && obs.getValueNumeric() != null) {
                    inr = obs.getValueNumeric();
                    break;
                }
            }
        }

        if (inr != null && inr > 5) {
            insert(new PatientFlag(
                $patient,
                null,
                "High INR - Bleeding Risk"
            ));
        }
end
