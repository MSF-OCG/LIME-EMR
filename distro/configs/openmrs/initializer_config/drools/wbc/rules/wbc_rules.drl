package org.openmrs.module.drools.wbc

import org.openmrs.Patient
import org.openmrs.Obs
import org.openmrs.Concept
import org.openmrs.api.context.Context
import org.openmrs.module.patientflags.PatientFlag

global Object service;

rule "High_WBC"
    agenda-group "highwbc"
    when
        $patient: Patient()
    then
        Concept wbcConcept = Context.getConceptService().getConceptByMapping("678", "CIEL");

        java.util.List<Obs> obsList = Context.getObsService().getObservationsByPersonAndConcept(
            $patient,
            wbcConcept
        );

        Double wbc = null;

        if (obsList != null && !obsList.isEmpty()) {
            for (Obs obs : obsList) {
                if (obs != null && !obs.getVoided() && obs.getValueNumeric() != null) {
                    wbc = obs.getValueNumeric();
                    break;
                }
            }
        }

        if (wbc != null && wbc > 15) {
            insert(new PatientFlag(
                $patient,
                null,
                "High WBC - Infection Alert"
            ));
        }
end
