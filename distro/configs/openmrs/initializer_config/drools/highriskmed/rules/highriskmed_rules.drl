package org.openmrs.module.drools.highriskmed

import org.openmrs.Patient
import org.openmrs.Concept
import org.openmrs.Order
import org.openmrs.DrugOrder
import org.openmrs.api.context.Context
import org.openmrs.module.patientflags.PatientFlag
import java.util.Arrays
import java.util.HashSet

global Object service;

rule "High_Risk_Medication"
    agenda-group "highriskmeds"
    when
        $patient: Patient()
    then
        // High-risk medication CIEL codes
        // Insulins: 282, 279, 78060 (human)
        // Anticoagulants:
        //   - 86416 (warfarin)
        //   - 166106 (apixaban), 166107 (rivaroxaban), 166108 (edoxaban), 76631 (fondaparinux)
        //   - 77414 (heparin sodium), 74225 (dalteparin), 75688 (enoxaparin)
        //   - 165448 (dabigatran)
        // Opioids:
        //   - 73667 (codeine), 76273 (fentanyl), 77702 (hydrocodone), 77744 (hydromorphone)
        //   - 80106 (morphine), 81332 (oxycodone), 81348 (oxymorphone), 85276 (tramadol)
        String[] highRiskCodes = {
            // Insulins
            "4689", "78064", "4687",
            // Anticoagulants
            "86416", "166106", "166107", "166108", "76631", "77414", "74225", "75688", "165448",
            // Opioids
            "73667", "76273", "77702", "77744", "80106", "81332", "81348", "85276"
        };
        java.util.Set<String> highRiskSet = new HashSet<String>(Arrays.asList(highRiskCodes));

        java.util.List<Order> activeOrders = Context.getOrderService().getActiveOrders(
            $patient,
            null,
            null,
            null
        );

        boolean hasHighRiskMed = false;

        if (activeOrders != null) {
            for (Order order : activeOrders) {
                if (order instanceof DrugOrder) {
                    DrugOrder drugOrder = (DrugOrder) order;
                    if (drugOrder.getDrug() != null && drugOrder.getDrug().getConcept() != null) {
                        Concept drugConcept = drugOrder.getDrug().getConcept();
                        // Check if drug concept has a CIEL mapping in our high-risk list
                        org.openmrs.ConceptMap mapping = null;
                        for (org.openmrs.ConceptMap m : drugConcept.getConceptMappings()) {
                            if (m.getConceptReferenceTerm() != null &&
                                m.getConceptReferenceTerm().getConceptSource() != null &&
                                "CIEL".equals(m.getConceptReferenceTerm().getConceptSource().getName())) {
                                String code = m.getConceptReferenceTerm().getCode();
                                if (highRiskSet.contains(code)) {
                                    hasHighRiskMed = true;
                                    break;
                                }
                            }
                        }
                    }
                }
                if (hasHighRiskMed) break;
            }
        }

        if (hasHighRiskMed) {
            insert(new PatientFlag(
                $patient,
                null,
                "High-risk Medication"
            ));
        }
end
