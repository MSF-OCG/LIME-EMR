package org.openmrs.module.drools.pendingsurgery

import org.openmrs.Patient
import org.openmrs.api.context.Context
import org.openmrs.module.patientflags.PatientFlag
import java.util.Date
import java.util.Calendar
import java.util.List
import java.util.ArrayList

global Object service;

rule "Pending_Surgery"
    agenda-group "pendingsurgery"
    when
        $patient: Patient()
    then
        // Calculate date range: now to 7 days from now
        Calendar cal = Calendar.getInstance();
        Date startDate = cal.getTime();
        cal.add(Calendar.DAY_OF_MONTH, 7);
        Date endDate = cal.getTime();

        boolean hasPendingSurgery = false;

        try {
            // Get Bahmni AppointmentsService
            Class<?> serviceClass = Class.forName("org.openmrs.module.appointments.service.AppointmentsService");
            Object appointmentsService = Context.getService(serviceClass);

            if (appointmentsService != null) {
                // Get all appointments in date range
                java.lang.reflect.Method getAllInRange = appointmentsService.getClass().getMethod(
                    "getAllAppointmentsInDateRange",
                    Date.class,
                    Date.class
                );

                List<?> allAppointments = (List<?>) getAllInRange.invoke(appointmentsService, startDate, endDate);

                if (allAppointments != null) {
                    // Get AppointmentStatus.Scheduled
                    Class<?> statusClass = Class.forName("org.openmrs.module.appointments.model.AppointmentStatus");
                    Object scheduledStatus = Enum.valueOf((Class<Enum>) statusClass, "Scheduled");

                    for (Object apt : allAppointments) {
                        // Get patient from appointment
                        java.lang.reflect.Method getPatient = apt.getClass().getMethod("getPatient");
                        org.openmrs.Patient aptPatient = (org.openmrs.Patient) getPatient.invoke(apt);

                        if (aptPatient != null && aptPatient.getPatientId().equals($patient.getPatientId())) {
                            // Check status
                            java.lang.reflect.Method getStatus = apt.getClass().getMethod("getStatus");
                            Object status = getStatus.invoke(apt);

                            if (scheduledStatus.equals(status)) {
                                // Check if service name contains surgery-related keywords
                                java.lang.reflect.Method getService = apt.getClass().getMethod("getService");
                                Object aptService = getService.invoke(apt);

                                if (aptService != null) {
                                    java.lang.reflect.Method getName = aptService.getClass().getMethod("getName");
                                    String serviceName = (String) getName.invoke(aptService);

                                    if (serviceName != null) {
                                        String lowerName = serviceName.toLowerCase();
                                        if (lowerName.contains("surgery") || lowerName.contains("surgical") ||
                                            lowerName.contains("operation") || lowerName.contains("procedure") ||
                                            lowerName.contains("OR") || lowerName.contains("theatre")) {
                                            hasPendingSurgery = true;
                                            break;
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        } catch (Exception e) {
            // Appointments module may not be installed or other error
        }

        if (hasPendingSurgery) {
            insert(new PatientFlag(
                $patient,
                null,
                "Pending Surgery"
            ));
        }
end
